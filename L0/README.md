# Order Info Service

## Описание
Демонстрационный сервис, предоставляющий API для получения информации о заказах и их товарах. Использует PostgreSQL для хранения данных, Kafka для обработки событий, локальный кэш для ускорения работы и встроенный фронтенд на HTML/CSS/JS.

## Структура проекта
```
LO/
├── order_info_service/
│   ├── cmd/
│   │   ├── app/                # Основное приложение
│   │   │   └── frontend/       # Встроенный фронтенд
│   │   │       ├── index.html
│   │   │       ├── script.js
│   │   │       └── style.css
│   │   │   └── main.go
│   │   └── producer/           # Производитель тестовых данных
│   │       └── main.go
│   ├── internal/
│   │   ├── cache/              # Реализация кэша
│   │   ├── controller/         # Бизнес-логика
│   │   ├── dto/                # Преобразование данных
│   │   ├── handler/            # HTTP-хендлеры
│   │   ├── kafka_consumer/     # Потребитель Kafka
│   │   ├── logger/             # Логирование
│   │   └── repository/         # Работа с базой данных
│   ├── pkg/
│   │   ├── model/               # Модели данных
│   │   └── srvcerrors/          # Кастомные ошибки сервиса
│   ├── test/                     # Тесты
│   ├── docker-compose.dev.yml    # Конфигурация Docker для разработки
│   ├── docker-compose.kafka.yml  # Конфигурация Docker для разработки
│   └── Makefile                  # Цели для сборки и запуска
└── db/                            # SQL-скрипты для инициализации БД

```

## Запуск
1. **Запуск всего окружения**:
   ```bash
   make run-dev
   ```
   Запускает PostgreSQL, Kafka, приложение и потребителя Kafka.

2. **Фронтенд**:
   После запуска откройте [http://localhost:8080](http://localhost:8080) в браузере.

3. **Генерация тестовых данных**:
   ```bash
   make producer
   ```
   Генерирует 10 тестовых заказов и отправляет их в Kafka.

## Тестирование
```bash
make test-all          # Все тесты
make test-repository   # Тесты репозитория
make test-cache        # Тесты кэша
make test-controller   # Тесты контроллера
make test-handler      # Тесты хендлеров
```

## Завершение работы
```bash
make stop-all
```

## Ключевые моменты реализации

- Кастомные ошибки (`ErrNotFound`, `ErrDatabase` и др.) обеспечивают точную диагностику проблем и соответствующее логгирование.

- Транзакции реализованы по паттерну `Unit of Work` с передачей транзакции через интерфейс `Querier`, что позволяет создавать связанные операции внутри одной и той же транзакции без реальной вложенности на уровне БД.

- Товары загружаются "лениво" через курсорную пагинацию с использованием `last_id` вместо `offset`, что обеспечивает эффективную навигацию по большим наборам данных.

- `Middleware`-логгер фиксирует время выполнения запросов, демонстрируя ускорение при `cache hit` (десятые доли миллисекунды, видно из поля duration в логгах) по сравнению с `cache miss` (десятки миллисекунд).

- Валидация структур данных осуществляется с помощью go-playground/validator с использованием тегов.

- Makefile для автоматизации тестирования и запуска, а также управления зависимостями и окружением.

- Для каждого слоя (`repository`, `cache`, `controller`, `handler`) реализованы unit-тесты с использованием моков.

- Интерфейсы (`RepositoryProvider`, `ControllerProvider` и др.) обеспечивают слабую связность компонентов, упрощают тестирование и позволяют легко заменять реализацию.
